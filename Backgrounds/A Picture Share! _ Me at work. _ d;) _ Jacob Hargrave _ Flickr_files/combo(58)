YUI.add("favorites-route",function(e){function t(e){t.superclass.constructor.call(this,e)}var a=require("hermes-core/type-validator");e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var o,i,r,s=this,n={},l=!1,u=!!t.headers&&t.headers["user-agent"],g=t.params.nsid_or_path_alias,d=t.params&&t.params.photo_id,p=d?100:25,m=this.getPageNumber(t),c=t.geo;return u&&null!==u.match(/^Twitterbot/i)&&(l=!0),a.nsid(g)?n.id=g:n.pathAlias=g,i="/photos/"+g+"/favorites/",o={page:100/p*(m-1)+1,perPage:p,withPhotoId:d},e.Promise.all([this.appContext.getModel("favorite-models",n,o),this.appContext.getModel("person-contacts-count-models",n)]).then(function(n){var u=0,p=n[0];if(YUI.Env.isServer&&(u=Math.ceil(p.getValue("totalItems")/100),m>u&&o.page>1&&!isNaN(parseInt(t.params.page_number,10))))return e.Promise.resolve({redirect:i.replace(/page[0-9]+/,"")});if(d){var h=p.getValue("photoPageList");if(-1===(r=h.getPageOf({id:d},50))||h.getNextIncompletePage(o)===r)return o.forceAPICall=!0,a.nsid(g)?o.id=g:o.pathAlias=g,h.getPage(o).then(function(e){return m=Math.ceil(50*h.getPageOf({id:d},50)/100),r=m,s.onRouteResolved(p,m,r,i,d,l,c)},function(e){return 2===e.code?(m=s.getPageNumber(t),r=2*(m-1)+1,s.onRouteResolved(p,m,r,i,d,l,c)):s.onRouteRejected(e,t)});m=Math.ceil(50*h.getPageOf({id:d},50)/100),r=m}else r=2*(m-1)+1;return s.onRouteResolved(p,m,r,i,d,l,c)},function(a){return 2===a.code?e.Promise.resolve({redirect:i}):a.timeout?s.appContext.getModel("person-models",n).then(function(t){var a=t.getValue("displayname"),o={view:"empty-page-view",layout:"scrolling",title:s.intlMessage({intlName:"common.USERS_ALBUMS",who:a}),params:{isSlow:!0,page:"favorites",displayName:a,nsid:t.getValue("nsid")}};return e.Promise.resolve(o)},function(){return s.onRouteRejected(a,t)}):s.onRouteRejected(a,t)})},onRouteResolved:function(t,a,o,i,r,s,n){var l,u=t.getValue("totalItems"),g=t.getValue("owner").getValue("displayname"),d=u>2500;return l=0===parseInt(u,10)?{view:"empty-page-view",layout:"scrolling",title:this.intlMessage({intlName:"common.USERS_FAVES",who:g}),params:{displayName:g,nsid:t.getValue("owner").getValue("nsid"),page:"favorites",hideMorePages:d,geo:n}}:{view:"favorites-page-view",layout:"scrolling",title:this.intlMessage({intlName:"common.USERS_FAVES",who:g}),params:{nsid:t.id,withPhotoId:r,isTwitterbot:s,pageParams:{page:o,perPage:r?100:50,viewPageSize:100,nominalPage:a},baseURL:i,hideMorePages:d,geo:n}},e.Promise.resolve(l)},onRouteRejected:function(t,a){var o="Couldn't load favorites page";if(t.message&&(o+=": "+t.message),t.fatal)throw t;return this.displayRouteErrors(a,new e.RouteError(404,o))}}),e.mix(t.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","favorite-models"],langBundles:["common"]});
YUI.add("hermes-template-scrollable-comment-list-view",function(e,a){var s=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,a,s,t,l){var n=null!=a?a:{},i=s.helperMissing,m=e.escapeExpression;return'<div class="comment-list-container loading">\n\t<ol class="comment-list">\n\t</ol>\n\t<div class="loading-text">'+m((s.intlMessage||a&&a.intlMessage||i).call(n,{name:"intlMessage",hash:{intlName:"comments.LOADING_COMMENTS"},data:l}))+'</div>\n\t<div class="no-comments-text">'+m((s.intlMessage||a&&a.intlMessage||i).call(n,{name:"intlMessage",hash:{intlName:"comments.NO_COMMENTS"},data:l}))+"</div>\n</div>"},useData:!0}),t={};e.Array.each([],function(a){var s=e.Template.get("hermes/"+a);s&&(t[a]=s)}),e.Template.register("hermes/scrollable-comment-list-view",function(a,l){return l=l||{},l.partials=l.partials?e.merge(t,l.partials):t,s(a,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("scrollable-comment-list-view",function(t,e){var s=require("hermes-core/flog")(e);t.namespace("Views")[this.name]=t.Base.create(this.name,t.Views["comment-list-view"],[],{langBundles:this.details.langBundles,initializer:function(t){this.constructor.superclass.initializer.call(this,t),this.listRegistryName=t.commentListConfig.listRegistryName,this.listId=t.commentListConfig.modelId},loadState:function(){var t=this;return t.appContext.getModel(t.listRegistryName,{id:t.listId}).then(function(e){t.commentListModel=e}).catch(function(t){throw s.error("Error getting comment list info",{err:t}),t})},buildContainer:function(){this.setContainerWithTemplate("scrollable-comment-list-view",this.params)},activate:function(){var t=this.get("container");this.listContainerNode=t.one(".comment-list-container"),this.scrollableEl=this.listContainerNode.getDOMNode(),this.registerEventHandler(this.commentListModel.on("valuesChanged",this.handleCommentListChange.bind(this),!0)),this.constructor.superclass.activate.call(this)},handleCommentListChange:function(t){0===t.comments.newVal.getList().length?this.showNoCommentsMessage():this.listContainerNode.removeClass("no-comments")},showNoCommentsMessage:function(){var t=this;this.listContainerNode.addClass("no-comments"),setTimeout(function(){t.fire("subviewViewEvent",{eventName:"emptyCommentContainer"})},300)},getNumOfComments:function(){return this.commentListModel.getValue(this.params.commentListConfig.collectionName).getList().length},setLoading:function(t){this.isLoading=t,this.listContainerNode.toggleClass("loading",t)},handleLoadCommentsComplete:function(){this.listContainerNode.removeClass("loading"),0===this.getNumOfComments()&&this.showNoCommentsMessage(),this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight,this.registerEventHandler(this.listContainerNode.on("scroll",this.handleCommentsScroll.bind(this)))},appendNewComment:function(t){0===this.getNumOfComments()&&this.listContainerNode.removeClass("no-comments"),this.constructor.superclass.appendNewComment.call(this,t)},handleCommentsScroll:function(t){!this.isFetchingComments&&this.scrollableEl.scrollTop<=0&&this.getMoreComments()},showCommentLoading:function(t){t?this.showBalls(!1):this.hideBalls()},showCommentAddLoading:function(t){t?(this.showBalls(!0),this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight):this.hideBalls()},handleCommentViewAppended:function(t){this.scrollableEl.scrollTop=this.scrollableEl.scrollHeight},updateComments:function(t){var e=this;return t.forEach(function(t){e.renderedCommentModels.push(t)}),this.prependComments(t)},prependComments:function(e){var s=this,i=[],n=[];return e.forEach(function(e){var o=e.toJSON(),l=Object.assign(o,{appContext:this.appContext});l.isSubjectOwner=s.isSubjectOwner;var a=new t.Views["comment-item-view"](l),m=a.initialize(l).then(function(){a.activate()});n.push(a),i.push(m)}),t.Promise.all(i).then(function(){s.prependCommentViewsToDom(n)})},prependCommentViewsToDom:function(e){var s,i=this,n=this.scrollableEl,o=n.scrollHeight,l=n.scrollTop;e.forEach(function(e){(s=t.Node.create('<li class="comment-list-item"></li>')).append(e.get("container")),i.commentsListNode.prepend(s)}),n.scrollTop=n.scrollHeight-o+l}})},"@VERSION@",{requires:["flickr-view","comment-list-view","hermes-template-scrollable-comment-list-view"],langBundles:["common","comments"]});YUI.add("hermes-template-photo-comments-view",function(e,t){var a=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,t,a,n,s){var l=null!=t?t:{},o=a.helperMissing,i=e.escapeExpression;return'<section class="comments-list-section">\n\t'+i((a.outlet||t&&t.outlet||o).call(l,null!=t?t["scrollable-comment-list-view"]:t,{name:"outlet",hash:{},data:s}))+'\n</section>\n\n<section class="add-comment-section">\n\t'+i((a.outlet||t&&t.outlet||o).call(l,null!=t?t["add-comment-view"]:t,{name:"outlet",hash:{},data:s}))+"\n</section>\n"},useData:!0}),n={};e.Array.each([],function(t){var a=e.Template.get("hermes/"+t);a&&(n[t]=a)}),e.Template.register("hermes/photo-comments-view",function(t,s){return s=s||{},s.partials=s.partials?e.merge(n,s.partials):n,a(t,s)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-comment-edit",function(t,e){var n=t.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(t,e,n,a,s){var i,l=null!=e?e:{},m=n.helperMissing,o=t.escapeExpression;return'<div class="comment-edit">\n\t<textarea class="edit-field">'+o("function"==typeof(i=null!=(i=n.content||(null!=e?e.content:e))?i:m)?i.call(l,{name:"content",hash:{},data:s}):i)+'</textarea>\n\t<div class="buttons edit-comment-buttons">\n\t\t<button type="button" class="mini alt cancel-edit-button">'+o((n.intlMessage||e&&e.intlMessage||m).call(l,{name:"intlMessage",hash:{intlName:"common.CANCEL"},data:s}))+'</button>\n\t\t<button type="button" class="mini action submit-edit-button">'+o((n.intlMessage||e&&e.intlMessage||m).call(l,{name:"intlMessage",hash:{intlName:"common.DONE"},data:s}))+"</button>\n\t</div>\n</div>"},useData:!0}),a={};t.Array.each([],function(e){var n=t.Template.get("hermes/"+e);n&&(a[e]=n)}),t.Template.register("hermes/comment-edit",function(e,s){return s=s||{},s.partials=s.partials?t.merge(a,s.partials):a,n(e,s)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-comments-view",function(e,t){require("hermes-core/flog")(t);e.namespace("Views")[this.name]=e.Base.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){this.params=e,this.params.commentListConfig={type:"photo",listRegistryName:"photo-comments-models",modelId:e.photoId,collectionName:"comments",commentModelRegistryName:"comment-models"},this.params.addCommentConfig={type:"photo",commentModelRegistryName:"comment-models",addCommentText:e.addCommentText||this.intlMessage({intlName:"comments.ADD_PHOTO_COMMENT",mediaType:"photo"})},this.commentsPage=0,this.signedIn=this.appContext.getViewer().signedIn},subviewConfig:{"scrollable-comment-list-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1},"add-comment-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!1}},loadState:function(){var t=this,o=[this.appContext.getModelRegistry("comment-models").then(function(e){t.commentModelRegistry=e}),this.appContext.getModel("photo-engagement-models",this.params.photoId).then(function(e){this.engagementModel=e}.bind(this)),this.appContext.getModel(this.params.commentListConfig.listRegistryName,this.params.commentListConfig.modelId).then(function(e){t.listModel=e})];return this.signedIn&&o.push(this.appContext.getModel("person-models",{id:this.appContext.getViewer().nsid}).then(function(e){t.userModel=e})),e.Promise.all(o)},buildContainer:function(){this.setContainerWithTemplate("photo-comments-view",{user:this.signedIn?this.userModel.toJSON():null,signedIn:this.signedIn})},activate:function(){this.get("container");this.commentListView=this.subviews["scrollable-comment-list-view"],this.addCommentView=this.subviews["add-comment-view"]},delayPromise:function(t,o){return new e.Promise(function(e){setTimeout(function(){return e(o())},t)})},onSubviewEvent:function(t,o){var n;if(o&&o[0])switch((n=o[0]).eventName){case"replyClicked":this.addCommentView.addReplyMessage(n.pathAliasOrNSID,!1);break;case"emptyCommentContainer":this.addCommentView.focusCommentBox();break;case"commentAddLoading":e.rapidTracker.beacon(this.name,"galleryPhotoCommentAddClick"),this.commentListView.showCommentAddLoading(n.isLoading);break;case"commentAdded":this.commentListView.appendNewComment(n.commentModel),this.listModel.getValue(this.params.commentListConfig.collectionName).prependToList(n.commentModel),this.engagementModel.setValue("commentCount",this.engagementModel.getValue("commentCount")+1),this.fire("commentAdded");break;case"commentDeleted":this.listModel.getValue(this.params.commentListConfig.collectionName).removeFromList(n.commentModelId),this.engagementModel.setValue("commentCount",this.engagementModel.getValue("commentCount")-1),this.fire("commentDeleted")}}})},"@VERSION@",{requires:["flickr-view","comment-item-view","add-comment-view","scrollable-comment-list-view","hermes-template-photo-comments-view","hermes-template-comment-edit"],langBundles:["gallery","stats","comments","common"]});YUI.add("photo-list-photo-interaction-view",function(e,t){var i=require("hermes-core/type-validator"),o=require("hermes-core/flog")(t),n={css:{faveClickArea:".fave-area",commentClickArea:".comment-area",removeFaveTool:"remove-fave",removePoolTool:"remove-group-pool",removeShowCasePhoto:"remove-showcase-photo",removePhotosOfYou:"remove-photosof-you",scotchTool:"scotch-photo"}};e.namespace("Views")[this.name]=e.Base.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){var t=this.appContext.getViewer();return""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),t.signedIn&&e.nsid===t.nsid||this.set("viewingSelf",!1),this.appContext.flipper.isFlipped("enable-signed-out-cta-test")&&(this.signedOutTest=!0),e.photoPageUrl&&this.set("photoPageUrl",e.photoPageUrl),this.params=e,this.signedIn=t.signedIn,void 0!==e.showCurate?this.showCurate=e.showCurate:this.showCurate=this.appContext.flipper.isFlipped("enable-megadroparound")&&this.signedIn,this},loadState:function(){var t=[],i=this.get("listModelParams");return t.push(this.appContext.getModel(this.get("engagementModelName"),this.get("id"))),i&&t.push(this.appContext.getModel(i.registryName,i.modelIdOrAttributes)),e.Promise.all(t).then(function(e){var t=e[0],i=e[1];this.set("engagement",t),this.extraFunctionality={moreMenuItems:[]},this.params.removeOwnFaves?this.get("model").getValue("isOwner")&&!this.get("viewingSelf")&&(this.extraFunctionality.removeToolClass=n.css.removeFaveTool):this.params.removePoolPhoto?this.get("model").getValue("isOwner")?this.extraFunctionality.removeToolClass=n.css.removePoolTool:i&&(i.getValue("group").getValue("isAdmin")||i.getValue("group").getValue("isModerator"))&&(this.extraFunctionality.removeToolClass=n.css.removePoolTool):this.params.scotch?this.extraFunctionality.removeToolClass=n.css.scotchTool:this.params.removeShowCasePhoto?this.get("model").getValue("isOwner")&&this.get("viewingSelf")&&(this.extraFunctionality.removeToolClass=n.css.removeShowCasePhoto):this.params.removePhotosOfYou&&this.get("viewingSelf")&&(this.extraFunctionality.removeToolClass=n.css.removePhotosOfYou),this.params.excludePeople&&this.extraFunctionality.moreMenuItems.push("exclude-people"),this.params.banUser&&i&&(i.getValue("group").getValue("isAdmin")||i.getValue("group").getValue("isModerator"))&&this.extraFunctionality.moreMenuItems.push("ban-user"),this.params.removeUser&&i&&(i.getValue("group").getValue("isAdmin")||i.getValue("group").getValue("isModerator"))&&this.extraFunctionality.moreMenuItems.push("remove-user"),this.params.searchSimilar&&this.extraFunctionality.moreMenuItems.push("search-similar"),this.params.searchSimilarWithTerm&&this.extraFunctionality.moreMenuItems.push("search-similar-with-term"),this.params.bigScotch&&(this.extraFunctionality.bigScotchTitle=this.godMessage({intlName:"explore.DO_BIG_SCOTCH"})),this.extraFunctionality.moreMenuItems=this.extraFunctionality.moreMenuItems.join(",")}.bind(this))},buildContainer:function(t){var i=this.get("engagement"),o=i.getValue("faveCount"),n=i.getValue("isFaved"),a=i.getValue("canFave"),s=i.getValue("commentCount");return t=t||{},o=e.IntlNumber.format(o,this.appContext.lang,1),s=e.IntlNumber.format(s,this.appContext.lang,1),t.photo=this.get("model").toJSON(),t.photoPageUrl=this.get("photoPageUrl"),t.faveCount=o,t.isFaved=n,t.canFave=a,t.commentCount=s,t.displayCurate=this.showCurate,t.hasExtraFunctionality=Object.keys(this.extraFunctionality).length>0,t.removeToolClass=this.extraFunctionality.removeToolClass,t.moreMenuItems=this.extraFunctionality.moreMenuItems,t.bigScotchTitle=this.extraFunctionality.bigScotchTitle,this.setContainerWithTemplate("photo-list-photo-interaction",t),this},activate:function(){this.appContext.getViewer();var t=this.get("engagement"),i=this.get("container");return this.infoBar=i.one(".interaction-bar"),this.detailsNode=this.infoBar.one(".text"),this.infoBarEngagement=this.infoBar.one(".engagement"),this.faveNode=this.infoBarEngagement.one(".engagement-item.fave"),this.commentNode=this.infoBarEngagement.one(".engagement-item.comment"),this.appContext.flipper.isFlipped("enable-megadroparound")&&(this.curateNode=this.infoBar.one(".engagement-item.curate"),this.curateNode&&this.registerEventHandler(this.curateNode.on(["click","keydown"],this.handleCurateClick.bind(this)))),this.faveNode&&(this.faveCountNode=this.faveNode.one(".engagement-count"),this.registerEventHandler(this.faveNode.on(["click","keydown"],this.handleFaveClick.bind(this)))),this.commentNode&&(this.commentIconNode=this.commentNode.one(".engagement-icon"),this.commentTextNode=this.commentNode.one(".engagement-count"),this.registerEventHandler(this.commentNode.on(["click","keydown"],this.handleCommentClick.bind(this)))),this.registerEventHandler(t.on("valuesChanged",this.handleEngagementModelValuesChanged.bind(this))),this.registerEventHandler(e.on("resize",e.betterThrottle(this.updateBreakpoints.bind(this),500,this,!0))),this.updateBreakpoints(),this},handleFaveClick:function(e){var t,i,n,a,s;if("click"===e.type||13===e.keyCode||32===e.keyCode){if(t=this,i=e.currentTarget,n=i.one(".engagement-count"),s=this.appContext.getViewer(),e.halt(),this.faveNode.hasClass("can-not-fave"))return;if(!this.signedIn)return void this.showSignUpAndFaveModal();this.isFaving||(this.isFaving=!0,this.get("engagement").toggleFave(),a=this.get("engagement").getValue("faveCount"),i.toggleClass("faved",this.get("engagement").getValue("isFaved")),n.toggleClass("empty",0===a),n&&a>0?n.set("text",a):n.set("text",""),this.get("engagement").remoteUpdate().then(function(){this.appContext.getModelRegistry("favorite-models").then(function(e){e.proxy(s.nsid).getValue("photoPageList").remove(t.get("model"))}),this.isFaving=!1}.bind(this),function(e){3!==e.code&&(this.get("engagement").toggleFave(),i.toggleClass("faved",this.get("engagement").getValue("isFaved")),n&&(n.set("text",a),n.toggleClass("empty",0===a))),o.error("Error faving photo",{err:e}),this.isFaving=!1}.bind(this)))}},handleCommentClick:function(t){var i,o,n=this;"click"!==t.type&&13!==t.keyCode&&32!==t.keyCode||(t.halt(),i=new e.Views["photo-comments-view"]({appContext:this.appContext,photoId:this.get("model").getValue("id"),isScrollable:!0,addCommentText:this.intlMessage({intlName:"comments.ADD_PHOTO_COMMENT",mediaType:this.get("model").getValue("mediaType")})}),(o=new e.ModalDroparoundHelper(this.appContext,{configs:{common:{subview:i},droparound:{preferTop:!0,width:400,height:400,anchorElement:this.commentIconNode,keyboardAnchorElement:this.commentIconNode},modal:{}}})).show(),n.registerEventHandler(e.on("addComment:showingSignupModal",function(){o.close()})),o.on("close",function(){n.commentNode.removeClass("active"),n.fire("hoverActionClosed")}),this.commentNode.addClass("active"),this.fire("hoverActionOpened"))},showSignUpAndFaveModal:function(){var t,i=this.intlMessage({intlName:"fave-view.SIGN_IN_BEFORE_FAVE_TITLE"}),o=this.intlMessage({intlName:"fave-view.JOIN_FLICKR_AND_FAVE"}),n=this.get("engagement"),a=n.getValue("id"),s=e.url(e.URLHelper.getPhotoPage({photoId:a,pathAlias:n.getValue("ownerNsid")}));(t=new e.Views.SignUpModal({appContext:this.appContext,signUpHeaderClass:"signup-fave",signUpTitle:i,signUpMessage:o,beaconPrefix:"fave"})).on("signUpClick",function(t){e.SigninHelper.signUpPendingFave({id:a},{postLoginUrl:s})}),t.on("signInClick",function(t){e.SigninHelper.addPendingFave({id:a},{postLoginUrl:s})}),t.show()},showSignUpAndCommentModal:function(){var t,i,o=this.intlMessage({intlName:"photo-page-scrappy.SIGNUP_AND_COMMENT_TITLE"}),n=this.intlMessage({intlName:"photo-page-scrappy.SIGNUP_AND_COMMENT_MESSAGE"}),a=this.get("engagement");e.rapidTracker.beacon(this.name,"commentIconClick"),i=e.url(e.URLHelper.getPhotoPage({photoId:a.getValue("id"),pathAlias:a.getValue("ownerNsid")})),(t=new e.Views.SignUpModal({appContext:this.appContext,signUpHeaderClass:"signup-comment",signUpTitle:o,signUpMessage:n,beaconPrefix:"comment"})).on("signUpClick",function(t){e.SigninHelper._redirectToSignUp("comment",{postLoginUrl:i})}),t.on("signInClick",function(t){e.SigninHelper._redirectToSignin("comment",{postLoginUrl:i})}),t.show()},handleEngagementModelValuesChanged:function(t){var i;t.commentCount&&(i=t.commentCount.newVal,this.commentTextNode.set("text",e.IntlNumber.format(i,this.appContext.lang,1)),this.commentTextNode.toggleClass("hidden",0===i),this.updateBreakpoints()),void 0===t.faveCount&&void 0===t.isFaved&&void 0===t.canFave||this.updateBreakpoints()},handleCurateClick:function(e){"click"!==e.type&&13!==e.keyCode&&32!==e.keyCode||(e.halt(),this.showAddToCuration())},showAddToCuration:function(){var t=this,i=this.get("model").getValue("isOwner"),o=new e.CurationHelper(this.appContext);"fluid-droparound-view"===o.showAddToCuration({photoId:this.get("model").getValue("id"),showAlbums:i,showGalleries:!i,anchorNode:this.curateNode}).name&&(t.fire("hoverActionOpened"),o.on("curateDroparoundClosed",function(){t.fire("hoverActionClosed")}))},updateBreakpoints:function(){var e=0;0!==this.infoBar.get("clientWidth")&&(this.infoBar.addClass("invisible"),this.infoBar.removeClass("narrow"),this.detailsNode.removeClass("hidden"),this.commentNode.removeClass("hidden"),this.curateNode&&this.curateNode.removeClass("hidden"),this.faveNode&&(this.faveNode.removeClass("hidden"),this.faveNode.removeClass("last"),this.faveCountNode.removeClass("hidden")),this.detailsNode.get("clientWidth")<=10&&(this.infoBar.addClass("narrow"),this.detailsNode.addClass("hidden")),this.infoBar.get("clientWidth")<this.infoBarEngagement.get("clientWidth")+24&&(this.commentNode.addClass("hidden"),this.curateNode?e=this.curateNode.get("clientWidth"):this.faveNode.addClass("last"),this.faveCountNode&&this.infoBar.get("clientWidth")<e+this.faveNode.get("clientWidth")+24&&this.faveCountNode.addClass("hidden"),this.curateNode&&this.infoBar.get("clientWidth")<this.infoBarEngagement.get("clientWidth")+24&&(this.curateNode.addClass("hidden"),this.faveNode.addClass("last"))),this.infoBar.removeClass("invisible"))},destructor:function(){}},{ATTRS:{id:{writeOnce:"initOnly",validator:function(e,t){return i.photoId(e)}},model:{writeOnce:"initOnly"},listModelParams:{writeOnce:"initOnly"},photoPageUrl:{writeOnce:"initOnly"},engagement:{value:null},viewingSelf:{value:!0},engagementModelName:{writeOnce:"initOnly",value:null,validator:function(t,i){return e.AttributeHelpers.validateString(t)}},layoutWidth:{validator:function(t,i){return e.AttributeHelpers.validateFloat(t)},setter:function(t){return e.AttributeHelpers.coerceFloat(t)||void 0},defaultFn:function(e){return 0}},isFaving:{value:!1,validator:function(t,i){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)}}}})},"@VERSION@",{requires:["flickr-view","hermes-template-photo-list-photo-interaction","attribute-helpers","fluid-modal-view","fluid-droparound-view","add-to-stuff-view","photo-comments-view","url","intl-number","curation-helper"],optionalRequires:["fluid"],langBundles:["fave-view","common","photo-page-scrappy","comments"]});YUI.add("hermes-lang-fave-view",function(e,t){e.Intl.add("hermes/fave-view","en-US",{COULDNT_FAVE:["We couldn't fave at this time"],SIGN_IN_TO_FAVE:["You must be signed in to fave. Please sign in now."],LOADING_FAVES:["Loading Faves..."],UNFAVE_PHOTO:["Unfave this photo"],FAVE_PHOTO:["Fave this photo"],WHO_FAVED:["Who faved this photo"],SIGN_IN_BEFORE_FAVE_TITLE:["You found a photo to fave!"],SIGN_IN_BEFORE_FAVE_MESSAGE:["That's great. Just sign in to fave it."],SIGN_IN_AND_FAVE:["Sign in and fave"],JOIN_FLICKR_AND_FAVE:["Join Flickr to add this photo to your favorites."]})},"@VERSION@",{requires:["intl"]});
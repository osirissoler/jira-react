YUI.add("photostream-route",function(e){function t(e){t.superclass.constructor.call(this,e)}var o=require("hermes-core/type-validator"),i="pu";e.Routes[this.name]=t,e.extend(t,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(t){var r,s,a,l=this,n=t.params.nsid_or_path_alias,d=!!t.headers&&t.headers["user-agent"],p=t.params&&t.params.photo_id,u=p?100:25,m=this.getPageNumber(t),h={},c=[],g=this.appContext.getViewer(),f=t.geo;d&&null!==d.match(/^Twitterbot/i)?this.isTwitterbot=!0:this.isTwitterbot=!1,this.isEdit=t.params&&t.params.edit,this.isCameraroll=t.query&&void 0!==t.query.cameraroll,s=this.isEdit?"/photos/"+n+"/edit/":"/photos/"+n+"/";var P=t.query&&""===t.query.helloPro||!1;return r={page:100/u*(m-1)+1,perPage:u,withPhotoId:p},r.orderBy="use_pref",r.viewAs=l.isCameraroll?"me":"use_pref",r.createCompoundID=!p,o.nsid(n)?h.id=n:h.pathAlias=n,(g.signedIn||t.probableUser)&&(c.push(this.appContext.getModel("person-preferences-models",g.signedIn?g.nsid:t.probableUser)),c.push(this.appContext.getModel("person-contacts-count-models",h))),e.Promise.all(c).catch(function(e){if(e.getModelFailure&&t.probableUser)return t.probableUser=null,[];throw e}).then(function(d){var u,c,g,w=!!d[0]&&d[0],v=0,x={};return o.nsid(n)&&w&&(i=w.getValue("photostreamViewAsPref"),c=l.buildContextSuffix(w,n),h.id=n+"-"+c),l.appContext.getModel("photostream-models",h,r).then(function(d){if(g=d.getValue("owner").getValue("nsid"),YUI.Env.isServer&&(v=Math.ceil(d.getValue("totalItems")/100),m>v&&r.page>1&&!isNaN(parseInt(t.params.page_number,10))))return e.Promise.resolve({redirect:s.replace(/page[0-9]+/,"")});if(o.nsid(n)||(w?(i=w.getValue("photostreamViewAsPref"),c=l.buildContextSuffix(w,g),h.id=g+"-"+c):h.id=g),x.withPhotoId=p,x.contextSuffix=c,x.baseURL=s,x.isHelloPro=P,p){if(u=d.getValue("photoPageList"),-1===(a=u.getPageOf({id:p},50))||u.getNextIncompletePage(r)===a)return r.forceAPICall=!0,o.nsid(n)?r.id=n:r.pathAlias=n,u.getPage(r).then(function(e){return m=Math.ceil(50*u.getPageOf({id:p},50)/100),a=m,l.onRouteResolved(d,m,a,x,f)},function(t){return e.Promise.resolve({redirect:s})});m=Math.ceil(50*u.getPageOf({id:p},50)/100),a=m}else a=2*(m-1)+1;return l.onRouteResolved(d,m,a,x,f)},function(o){return o&&p?e.Promise.resolve({redirect:s}):o.timeout?l.appContext.getModel("person-models",h).then(function(t){var o=t.getValue("displayname"),r={view:"empty-page-view",layout:"scrolling",title:o,params:{geo:f,isSlow:!0,viewAs:l.isCameraroll?"me":i,page:"photostream",displayName:o,nsid:t.getValue("nsid"),isCamerarollPhotostream:l.isCameraroll}};return e.Promise.resolve(r)},function(){return l.onRouteRejected(o,t)}):l.onRouteRejected(o,t,s)})}).catch(function(e){return l.onRouteRejected(e,t,s)})},buildContextSuffix:function(t,o){return e.Models["person-preferences-models"].buildContextSuffix(t,o)},onRouteResolved:function(t,o,r,s,a){var l,n=t.getValue("totalItems"),d=t.getValue("owner").getValue("displayname"),p=t.getValue("owner").getValue("nsid"),u=this.appContext.getViewer(),m=!1;if(0===parseInt(n,10))l={view:"empty-page-view",layout:"scrolling",title:d,params:{geo:a,isHelloPro:s.isHelloPro,displayName:d,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:this.isCameraroll?"me":i,page:"photostream",isCamerarollPhotostream:this.isCameraroll}};else{if(m=u.signedIn&&u.nsid===p,this.appContext.flipper.isFlipped("enable-photostream-edit")&&this.isEdit&&!m)return e.Promise.resolve({redirect:s.baseURL.replace(/\/edit/,"")});l={view:this.appContext.flipper.isFlipped("enable-photostream-edit")&&this.isEdit?"photostream-edit-page-view":"photostream-page-view",layout:"scrolling",title:d,params:{geo:a,isHelloPro:s.isHelloPro,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:s.withPhotoId,isTwitterbot:this.isTwitterbot,contextId:p+"-"+s.contextSuffix,pageParams:{page:r,perPage:s.withPhotoId?100:50,viewPageSize:100,nominalPage:o,idAttribute:"contextId",createCompoundID:!s.withPhotoId},baseURL:s.baseURL,contextSuffix:s.contextSuffix,isCameraroll:this.isCameraroll}}}return e.Promise.resolve(l)},onRouteRejected:function(t,o,i){if(t.fatal)throw t;return 15===t.code?e.Promise.resolve({redirect:i}):5===t.code?this.displayRouteErrors(o,new e.RouteError(410,this.intlMessage({intlName:"common.404_PHOTOSTREAM_DELETED"}))):this.displayRouteErrors(o,new e.RouteError(404,this.intlMessage({intlName:"common.404_PHOTOSTREAM_NONEXISTENT"})))}}),e.mix(t.prototype,e.Localizable)},"@VERSION@",{requires:["flickr-route","flickr-promise","photostream-models","person-preferences-models"],langBundles:["common"]});